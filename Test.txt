ğŸ”§ PATCH 1 â€” ThÃªm xÃ¡c thá»±c chá»¯ kÃ½ sá»‘ vÃ o VerifyHeader
â• ThÃªm import:
"github.com/ethereum/go-ethereum/crypto"
"log"
â• ThÃªm hÃ m má»›i:
go
Copy
Edit
func (p *POVA) verifySignature(header *types.Header, expected common.Address) error {
	hash := header.Hash().Bytes()
	sig := header.Extra
	pubkey, err := crypto.SigToPub(hash, sig)
	if err != nil {
		return err
	}
	recovered := crypto.PubkeyToAddress(*pubkey)
	if recovered != expected {
		return errors.New("invalid block signature")
	}
	return nil
}
ğŸ§  Gá»i trong VerifyHeader:
Thay Ä‘oáº¡n nÃ y:

go
Copy
Edit
if header.Coinbase != expected {
	return errors.New("unauthorized block proposer")
}
Báº±ng:

go
Copy
Edit
if header.Coinbase != expected {
	return errors.New("unauthorized block proposer")
}
if err := p.verifySignature(header, expected); err != nil {
	return err
}
ğŸ”§ PATCH 2 â€” Bá» qua validator náº¿u timeout (Seal)
Trong Seal() thay Ä‘oáº¡n nÃ y:

go
Copy
Edit
select {
case <-time.After(delay):
case <-stop:
	return errors.New("sealing stopped")
}
Báº±ng:

go
Copy
Edit
maxWait := 30 * time.Second
select {
case <-time.After(delay):
case <-time.After(maxWait):
	log.Println("âš ï¸ Validator timeout, skipping block", "validator", block.Coinbase.Hex())
	return errors.New("validator timeout")
case <-stop:
	return errors.New("sealing stopped")
}
ğŸ”§ PATCH 3 â€” TÃ¡ch logic chá»n validator (dá»… nÃ¢ng cáº¥p vá» sau)
â• ThÃªm hÃ m:
go
Copy
Edit
func (p *POVA) getValidator(blockNum uint64) common.Address {
	return p.validators[(blockNum-1)%uint64(len(p.validators))]
}
ğŸ§  DÃ¹ng láº¡i trong Prepare, VerifyHeader:
go
Copy
Edit
expected := p.getValidator(blockNumber)
go
Copy
Edit
header.Coinbase = p.getValidator(blockNumber)
ğŸ”§ PATCH 4 â€” Log validator rotation
Trong VerifyHeader(), thÃªm:

go
Copy
Edit
log.Printf("ğŸ§¾ Block %d - Proposer: %s, Expected: %s", blockNumber, header.Coinbase.Hex(), expected.Hex())
ğŸ”§ PATCH 5 â€” Expose RPC API cho phÃ©p query validator cá»§a block báº¥t ká»³
â• Táº¡o hÃ m API:
go
Copy
Edit
type POVAAPI struct {
	engine *POVA
}

func (api *POVAAPI) CurrentValidator(blockNum hexutil.Uint64) (common.Address, error) {
	return api.engine.getValidator(uint64(blockNum)), nil
}
â• Sá»­a APIs():
go
Copy
Edit
func (p *POVA) APIs(chain consensus.ChainHeaderReader) []rpc.API {
	return []rpc.API{
		{
			Namespace: "pova",
			Version:   "1.0",
			Service:   &POVAAPI{engine: p},
			Public:    true,
		},
	}
}
Gá»i thá»­:
bash
Copy
Edit
curl -X POST http://localhost:8545 \
 -H "Content-Type: application/json" \
 -d '{"jsonrpc":"2.0","method":"pova_currentValidator","params":[123],"id":1}'
âœ… Sau khi patch xong
Báº¡n cÃ³:

XÃ¡c thá»±c chá»¯ kÃ½ block (tÄƒng báº£o máº­t)

LuÃ¢n chuyá»ƒn validator rÃµ rÃ ng (log + RPC)

Há»— trá»£ bá» qua validator bá»‹ treo

Kiáº¿n trÃºc dá»… má»Ÿ rá»™ng (staking / dynamic validator)